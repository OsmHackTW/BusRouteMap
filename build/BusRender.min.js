/*! BusRouteMap 2016-01-10 */
L.Bus={};var BusRenderVars={OSMAPIUrl:"http://api.openstreetmap.org/api/0.6/relation/",FullQuery:"/full",ButtonSet:'<button type="button" class="btn btn-default btn-sm" id="quetyBtn"><span class="glyphicon glyphicon-search" aria-hidden="true"></span>經過路線/動態</span></button>'};L.Bus.RenderManager=L.Class.extend({initialize:function(){this._RouteLayers=[],this._BusMainRouteLineOptions={},this._BusExtendRouteLineOptions={},this._BusIconOptions={},this._currentBusMarker=null},InitStopIconOption:function(a,b){var c=L.MakiMarkers.icon({color:b.StopColour,icon:"bus",size:"m"});this._BusIconOptions[a]=c},InitLeafletOption:function(a,b){this._currentBusMarker=this._BusIconOptions[a],this._BusMainRouteLineOptions={color:b.MainLineColour,opacity:1,clickable:!1},this._BusExtendRouteLineOptions={color:b.ExtendLineColour,opacity:1,clickable:!1}},DownloadRouteMaster:function(a,b,c){if(this._RouteLayers.length>0)for(var d=0;d<this._RouteLayers.length;d++)this._RouteLayers[d].clearLayers();$(".leaflet-popup-pane").off("click","#quetyBtn",QueryRealtimeBus);var e=this;$.ajax({url:BusRenderVars.OSMAPIUrl+a,dataType:"xml",success:function(a){var d=new L.Bus.getRoutesInMaster(a),f=0;e.BlockingMask({enable:!0},c);for(var g=0;g<d.length;g++)d[g].Direction===b&&(e.RenderRoute(d[g].Ref,d[g].Extend,function(a){e._RouteLayers.push(a)}),f++);0==f&&("undefined"==typeof bootbox?window.alert("此路線為單向行駛!"):bootbox.alert("此路線為單向行駛!")),$(".leaflet-popup-pane").on("click","#quetyBtn",QueryRealtimeBus),window.setTimeout(function(){e.BlockingMask({enable:!1},c)},2e3)},error:function(){"undefined"==typeof bootbox?window.alert("資料載入失敗!"):bootbox.alert("資料載入失敗!"),window.setTimeout(function(){e.BlockingMask(!1,c)},2e3)}})},RenderRoute:function(a,b,c){var d=this;$.ajax({url:BusRenderVars.OSMAPIUrl+a+BusRenderVars.FullQuery,dataType:"xml",success:function(a){layer=new L.Bus.DataLayer(a,b,d).addTo(CommonVars.MapObject),"MainRoute"===b&&CommonVars.MapObject.fitBounds(layer.getBounds()),null!==c&&c(layer)},error:function(){"undefined"==typeof bootbox?window.alert("資料載入失敗!"):bootbox.alert("資料載入失敗!")}})},BlockingMask:function(a,b){a.enable===!0?void 0==b||null==b?$.blockUI({message:"<h1>載入中...</h1>",css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px","border-radius":"10px",opacity:.5,color:"#fff"}}):$(b).block({message:"<h1>載入中...</h1>",css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px","border-radius":"10px",opacity:.5,color:"#fff"}}):null==b||void 0==b?$.unblockUI():$(b).unblock()}}),L.Bus.DataLayer=L.FeatureGroup.extend({options:{uninterestingTags:["source","source_ref","source:ref","history","attribution","created_by","tiger:county","tiger:tlid","tiger:upload_uuid"],styles:{}},initialize:function(a,b,c,d){L.Util.setOptions(this,d),L.FeatureGroup.prototype.initialize.call(this),a&&this.addData(a,b,c)},addData:function(a,b,c){var d={showCoverageOnHover:!1,maxClusterRadius:20},e=new L.MarkerClusterGroup(d);a instanceof Array||(a=this.buildFeatures(a));for(var f=0;f<a.length;f++){var g,h=a[f];if("node"===h.type){var i={icon:c._currentBusMarker,opacity:1,zIndexOffset:1e3,riseOnHover:!0,title:this.GetBusStopName(h.tags)};e.addLayer(L.marker(h.latLng,i).bindPopup("<h5>"+this.GetBusStopName(h.tags)+"</h5><br>站牌代碼：<b id='codeID'>"+this.GetBusStopCode(h.tags)+"</b><br>"+BusRenderVars.Button_Set))}else{for(var j=new Array(h.nodes.length),k=0;k<h.nodes.length;k++)j[k]=h.nodes[k].latLng;"MainRoute"===b?g=L.polyline(j,c._BusMainRouteLineOptions):"ExtendRoute"===b&&(g=L.polyline(j,c._BusExtendRouteLineOptions))}void 0!==g&&(g.addTo(this),g.feature=h)}void 0!==e&&e.addTo(this)},buildFeatures:function(a){var b=[],c=L.Bus.getNodes(a),d=L.Bus.getWays(a,c);L.Bus.getRelations(a,c,d);for(var e in c){var f=c[e];this.isBusStop(f)&&b.push(f)}for(var g=0;g<d.length;g++){var h=d[g];b.push(h)}return b},isBusStop:function(a){var b=!1;for(var c in a.tags)if("bus_stop"==a.tags[c]){b=!0;break}return b},GetBusStopName:function(a){var b="";for(var c in a)if("name"==c){b=a[c];break}return b},GetBusStopCode:function(a){var b=0;for(var c in a)if("ref"==c){b=a[c];break}return b}}),L.Util.extend(L.Bus,{getNodes:function(a){for(var b={},c=a.getElementsByTagName("node"),d=0;d<c.length;d++){var e=c[d],f=e.getAttribute("id");b[f]={id:f,type:"node",latLng:L.latLng(e.getAttribute("lat"),e.getAttribute("lon"),!0),tags:this.getTags(e)}}return b},getWays:function(a,b){for(var c=[],d=a.getElementsByTagName("way"),e=0;e<d.length;e++){for(var f=d[e],g=f.getElementsByTagName("nd"),h={id:f.getAttribute("id"),type:"way",nodes:new Array(g.length),tags:this.getTags(f)},i=0;i<g.length;i++)h.nodes[i]=b[g[i].getAttribute("ref")];c.push(h)}return c},getRoutesInMaster:function(a){for(var b=[],c=a.getElementsByTagName("relation"),d=0;d<c.length;d++)for(var e=c[d],f=e.getElementsByTagName("member"),g=0;g<f.length;g++)if("relation"===f[g].getAttribute("type")){var h="MainRoute",i="forward";switch(f[g].getAttribute("role")){case"forward":i="forward",h="MainRoute";break;case"backward":i="backward",h="MainRoute";break;case"forward_extend":i="forward",h="ExtendRoute";break;case"backward_extend":i="backward",h="ExtendRoute"}var j={Ref:f[g].getAttribute("ref"),Extend:h,Direction:i};b.push(j)}return b},getRelations:function(a,b,c){for(var d=[],e=a.getElementsByTagName("relation"),f=0;f<e.length;f++){for(var g=e[f],h=g.getElementsByTagName("member"),i={id:g.getAttribute("id"),type:"relation",members:new Array(h.length),tags:this.getTags(g)},j=0;j<h.length;j++)"node"===h[j].getAttribute("type")?i.members[j]=b[h[j].getAttribute("ref")]:i.members[j]=null;d.push(i)}return d},getTags:function(a){for(var b={},c=a.getElementsByTagName("tag"),d=0;d<c.length;d++)b[c[d].getAttribute("k")]=c[d].getAttribute("v");return b}});