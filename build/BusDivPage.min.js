/*! BusRouteMap 2016-01-14 */
function CreateBusMap(a){DivPageVars.RouteDownloadManager=new L.Bus.RenderManager,CommonVars.MapObject=L.map("map").setView([23.1852,120.4287],11),L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:CommonVars.MapAttribution}).addTo(CommonVars.MapObject),-1===a.search(",")?GetRouteByCode(a,"NoMulti",CommonVars.MapObject):GetRouteByCode(a,"Multi",CommonVars.MapObject)}function GetRouteByCode(a,b,c){$.getJSON(CommonVars.CategoryJsonUrl+CommonVars.JsonExtension,function(d){$.each(d,function(a,b){DivPageVars.RouteDownloadManager.InitStopIconOption(b.categoryOSMRef,b.colourScheme),DivPageVars.ColourSchemeCollect[b.categoryOSMRef]=b.colourScheme});var e;"Multi"===b?e=a.split(","):(e=[],e.push(a)),$.getJSON(DivPageVars.AllRoutesJsonUrl+CommonVars.JsonExtension,function(a){for(var d=0;d<e.length;++d)$.each(a,function(a,b){if(e[d]==b.RouteRef){var c={Category:b.RouteCategory,RelationID:b.RouteOSMRelation,Name:b.RouteName,CodeNum:b.RouteCode,OneWay:void 0!==b.OneWayRoute};return DivPageVars.RouteElements.push(c),!1}});e.length!==DivPageVars.RouteElements.length?window.alert("編號有誤!"):(c.addControl(new L.BusSelectRouteControl(DivPageVars.RouteElements)),void 0===DivPageVars.DirControl&&(DivPageVars.DirControl=new L.BusDirControl,c.addControl(DivPageVars.DirControl)),void 0===DivPageVars.InfoControl&&(DivPageVars.InfoControl=new L.BusInfoControl,c.addControl(DivPageVars.InfoControl)),"NoMulti"===b&&($(".selRoute").css("visibility","hidden"),$("#selr").css("visibility","hidden")),SetSelectRoute(),$("#selr").change(function(){SetSelectRoute()}),$('input[name="direction"]:radio').change(function(){SetSelectDir()}))})})}function SetSelectRoute(){var a=$("#selr option:selected").attr("value"),b=a.split(",");currentScheme=DivPageVars.ColourSchemeCollect[b[0]],DivPageVars.RouteDownloadManager.InitLeafletOption(b[0],currentScheme),void 0!==DivPageVars.DirControl&&(DivPageVars.DirControl.RefreshRelationID(b[1]),"true"===b[2]?DivPageVars.DirControl.ToggleVisible(!1):DivPageVars.DirControl.ToggleVisible(!0)),void 0!==DivPageVars.InfoControl&&DivPageVars.InfoControl.RefreshRelationCode(b[3]),SetSelectDir()}function SetSelectDir(){var a=$('input[name="direction"]:checked').val();DivPageVars.RouteDownloadManager.DownloadRouteMaster(DivPageVars.DirControl._busRelationID,a,DivPageVars.DivString)}function QueryRealtimeBus(){var a=$("#codeID").text();window.open(CommonVars.ConfigObject.BusStopRealTimeUrl+a,a)}var DivPageVars={AllRoutesJsonUrl:"LocalData/AllBusRoutes",RouteDownloadManager:void 0,DivString:"#map",DirControl:void 0,InfoControl:void 0,ColourSchemeCollect:{},RouteElements:[]};$(document).ready(function(){CommonVars.InitConfig(function(a){var b=$(DivPageVars.DivString);return void 0===b||void 0===b.attr("bus-ref")?void window.alert("找不到地圖Div或編號不存在!"):void CreateBusMap(b.attr("bus-ref"))})}),L.BusInfoControl=L.Control.extend({options:{position:"bottomleft"},initialize:function(a){L.Util.setOptions(this,a),this._busRelationCode=0},onAdd:function(a){var b=L.DomUtil.create("div","info");return $(b).html('<a id="rLink" href="#">'+CommonVars.ConfigObject.Localization.Info+"</a>"),b},onRemove:function(a){},RefreshRelationCode:function(a){this._busRelationCode=a,$("#rLink").html('<a id="rLink" href="'+CommonVars.ConfigObject.BusRouteInfoUrl+this._busRelationCode+'" target="_blank">'+CommonVars.ConfigObject.Localization.Info+"</a>")}}),L.BusDirControl=L.Control.extend({options:{position:"topright"},initialize:function(a){L.Util.setOptions(this,a),this._busRelationID=0},onAdd:function(a){var b='<input type="radio" name="direction" value="forward" checked>'+CommonVars.ConfigObject.Localization.Forward+"<br/>",c='<input type="radio" name="direction" value="backward">'+CommonVars.ConfigObject.Localization.Backward,d=L.DomUtil.create("div","dir");return $(d).append(b,c),d},onRemove:function(a){},RefreshRelationID:function(a){this._busRelationID=a},ToggleVisible:function(a){var b=$(".dir");void 0!==b&&(a===!0?b.css("visibility","visible"):a===!1&&b.css("visibility","hidden"))}}),L.BusSelectRouteControl=L.Control.extend({options:{position:"topleft"},initialize:function(a,b){L.Util.setOptions(this,b),this._RouteElements=a},onAdd:function(a){for(var b='<select id="selr">',c="</select>",d="",e=0;e<this._RouteElements.length;e++){var f='<option label="'+this._RouteElements[e].Name+'" value="'+this._RouteElements[e].Category+","+this._RouteElements[e].RelationID+","+this._RouteElements[e].OneWay+","+this._RouteElements[e].CodeNum+'">'+this._RouteElements[e].Name+"</option>";d+=f}var g=L.DomUtil.create("div","selRoute");return $(g).append(b+d+c),g},onRemove:function(a){}});